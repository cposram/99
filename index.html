<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä¹ä¹ä¹˜æ³•ï¼š50é¡Œæ¥µé€ŸæŒ‘æˆ°è³½</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(to bottom, #1a2a6c, #b21f1f, #fdbb2d); /* æ›´æœ‰æˆ°é¬¥æ„Ÿçš„èƒŒæ™¯ */
            user-select: none;
            -webkit-user-select: none;
            touch-action: none;
        }
        
        /* å„€è¡¨æ¿å€åŸŸ */
        #dashboard {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            padding: 10px 20px;
            box-sizing: border-box;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
            font-weight: bold;
            z-index: 20;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }

        .hud-item {
            font-size: 24px;
        }

        /* ä¸­å¤®å¤§é€²åº¦ */
        #progress-container {
            position: absolute;
            top: 60px;
            left: 50%;
            transform: translateX(-50%);
            width: 80%;
            max-width: 400px;
            text-align: center;
            z-index: 15;
            pointer-events: none;
        }

        #progress-text {
            color: rgba(255, 255, 255, 0.9);
            font-size: 20px;
            margin-bottom: 5px;
            font-weight: bold;
        }

        #progress-bar-bg {
            width: 100%;
            height: 15px;
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            overflow: hidden;
            border: 2px solid rgba(255,255,255,0.3);
        }

        #progress-bar-fill {
            height: 100%;
            width: 0%;
            background: #00ff00;
            transition: width 0.1s linear;
            box-shadow: 0 0 10px #00ff00;
        }

        #question-display {
            position: absolute;
            top: 15%; /* é¡Œç›®æ‹¿é«˜ä¸€é»ï¼Œä¸è¦æ“‹è¦–ç·š */
            left: 50%;
            transform: translateX(-50%);
            font-size: clamp(50px, 12vw, 90px);
            font-weight: 900;
            color: #fff;
            text-shadow: 0 4px 10px rgba(0,0,0,0.5);
            display: none;
            pointer-events: none;
            z-index: 20;
            white-space: nowrap;
        }

        /* å€’æ•¸è¨ˆæ™‚æ¢ (ç·Šè¿«æ„Ÿ) */
        #timer-line {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 8px;
            background: #ff00de;
            width: 100%;
            z-index: 20;
        }

        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.92);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            z-index: 100;
            padding: 20px;
            box-sizing: border-box;
            text-align: center;
        }

        .hidden { display: none !important; }

        h1 {
            font-size: clamp(30px, 8vw, 50px);
            margin-bottom: 10px;
            color: #FFD93D;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .mission-badge {
            background: #ff4757;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 20px;
            display: inline-block;
        }

        button {
            padding: 20px 60px;
            font-size: 24px;
            background: linear-gradient(to bottom, #2ecc71, #27ae60);
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(46, 204, 113, 0.4);
            font-weight: bold;
            margin-top: 30px;
            transition: transform 0.1s;
        }
        
        button:active { transform: scale(0.95); }

        /* è³½é“ç·š (æ¥µæ·¡) */
        .lane-guide {
            position: absolute;
            top: 0;
            bottom: 0;
            border-right: 1px dashed rgba(255,255,255,0.1);
            pointer-events: none;
        }

        .result-box {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }

        /* éŒ¯èª¤éœ‡å‹• */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20% { transform: translateX(-10px); }
            40% { transform: translateX(10px); }
            60% { transform: translateX(-10px); }
            80% { transform: translateX(10px); }
        }
        .shake { animation: shake 0.3s cubic-bezier(.36,.07,.19,.97) both; }

        /* ç­”å°é–ƒå…‰ */
        @keyframes flash {
            0% { background-color: rgba(255,255,255,0.5); }
            100% { background-color: transparent; }
        }
        .flash { animation: flash 0.2s; }

    </style>
</head>
<body>

    <div id="lanes-container"></div>
    <div id="timer-line"></div>
    <canvas id="gameCanvas"></canvas>

    <div id="dashboard">
        <div class="hud-item">â±ï¸ <span id="time-display">150.0</span>s</div>
        <div class="hud-item" style="color:#ff6b6b">âŒ <span id="mistake-display">0</span></div>
    </div>

    <div id="progress-container">
        <div id="progress-text">ç›®æ¨™é€²åº¦: <span id="score-display" style="font-size:1.2em; color:#00ff00">0</span> / 50</div>
        <div id="progress-bar-bg"><div id="progress-bar-fill"></div></div>
    </div>

    <div id="question-display">READY</div>

    <div id="start-screen" class="overlay">
        <h1>ğŸš€ æ¥µé€Ÿä¹˜æ³•æŒ‘æˆ°</h1>
        <div class="mission-badge">ä»»å‹™ç›®æ¨™ï¼š150ç§’å…§ç­”å°50é¡Œ</div>
        <p style="font-size: 18px; line-height: 1.6; opacity: 0.9;">
            é€™æ˜¯æ¨¡æ“¬æ¯”è³½æ¨¡å¼ã€‚<br>
            ç­”å°ç«‹å³æ›é¡Œï¼Œåˆ†ç§’å¿…çˆ­ã€‚<br>
            <span style="color:#ff6b6b">æ³¨æ„ï¼šç­”éŒ¯ä¸æ‰£åˆ†ï¼Œä½†æœƒå¡ä½ä¸¦æµªè²»æ™‚é–“ï¼</span>
        </p>
        <button onclick="game.start()">é–‹å§‹æŒ‘æˆ°</button>
    </div>

    <div id="end-screen" class="overlay hidden">
        <h1 id="end-title">æŒ‘æˆ°çµæŸ</h1>
        <div class="result-box">
            <h2 id="end-reason" style="margin-top:0; color:#FFD93D;">æ™‚é–“åˆ°</h2>
            <p style="font-size:20px;">
                æœ€çµ‚æˆç¸¾ï¼š<span id="final-score" style="font-size:40px; font-weight:bold;">0</span> / 50
            </p>
            <p style="font-size:18px;">
                è€—æ™‚ï¼š<span id="final-time">0</span> ç§’
            </p>
            <p style="font-size:18px; color:#ff6b6b;">
                éŒ¯èª¤æ¬¡æ•¸ï¼š<span id="final-mistakes">0</span>
            </p>
            <div id="feedback-msg" style="margin-top:15px; font-style:italic; color:#aaa;"></div>
        </div>
        <button onclick="game.start()">å†æ¬¡æŒ‘æˆ°</button>
    </div>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    
    // --- æ¯”è³½åƒæ•¸è¨­å®š ---
    const TARGET_SCORE = 50;  // ç›®æ¨™é¡Œæ•¸
    const TIME_LIMIT = 150;   // ç¸½æ™‚é–“ (ç§’)
    const LANES_COUNT = 4;    // è³½é“æ•¸
    const BALLOON_BASE_SPEED_MULTIPLIER = 1.2; // æ°£çƒåŸºç¤é€Ÿåº¦åŠ æˆ (1.0ç‚ºåŸé€Ÿ)

    // RWD
    function resize() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        drawLaneGuides();
    }
    
    function drawLaneGuides() {
        const container = document.getElementById('lanes-container');
        container.innerHTML = '';
        const w = window.innerWidth / LANES_COUNT;
        for(let i=1; i<LANES_COUNT; i++) {
            const line = document.createElement('div');
            line.className = 'lane-guide';
            line.style.left = (w * i) + 'px';
            container.appendChild(line);
        }
    }
    
    window.addEventListener('resize', resize);
    resize();

    class Balloon {
        constructor(number, isCorrect, laneIndex) {
            const laneWidth = canvas.width / LANES_COUNT;
            const maxRadius = Math.min(laneWidth * 0.35, 65); 
            this.radius = maxRadius;

            this.x = (laneIndex * laneWidth) + (laneWidth / 2);
            // å¾ç•«é¢åº•éƒ¨ä¸‹æ–¹éš¨æ©Ÿä½ç½®ç”Ÿæˆï¼Œè£½é€ é«˜ä½å·®
            this.y = canvas.height + this.radius + (Math.random() * 200);
            
            // é€Ÿåº¦è¨ˆç®—ï¼šç¢ºä¿æ°£çƒé£›å¾—å¤ å¿«ï¼Œé€¼è¿«ç©å®¶åæ‡‰
            // åŸºç¤é€Ÿåº¦è®“å®ƒç´„ 4-5 ç§’é£›éå…¨è¢å¹•
            let baseSpeed = (canvas.height) / 240; 
            this.speed = baseSpeed * (1 + Math.random() * 0.5) * BALLOON_BASE_SPEED_MULTIPLIER;
            if (this.speed < 2) this.speed = 2;

            this.number = number;
            this.isCorrect = isCorrect;
            // ä½¿ç”¨é®®è±”ä½†ç¨å¾®æ·±ä¸€é»çš„é¡è‰²ï¼Œé©åˆæ·±è‰²èƒŒæ™¯
            this.color = `hsl(${Math.random() * 360}, 85%, 55%)`; 
            this.popped = false;
        }

        update() {
            this.y -= this.speed;
        }

        draw(ctx) {
            if (this.popped) return;
            
            // æ°£çƒæœ¬é«”
            ctx.beginPath();
            ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
            ctx.fillStyle = this.color;
            ctx.fill();
            
            // ç«‹é«”å…‰æ¾¤
            ctx.beginPath();
            ctx.arc(this.x - this.radius * 0.3, this.y - this.radius * 0.3, this.radius * 0.25, 0, Math.PI * 2);
            ctx.fillStyle = "rgba(255,255,255,0.4)";
            ctx.fill();

            // ç¹©å­
            ctx.beginPath();
            ctx.moveTo(this.x, this.y + this.radius);
            ctx.lineTo(this.x, this.y + this.radius + 40);
            ctx.strokeStyle = "rgba(255,255,255,0.5)";
            ctx.lineWidth = 2;
            ctx.stroke();

            // æ•¸å­—
            ctx.fillStyle = "#fff";
            ctx.font = `bold ${this.radius * 0.9}px Arial`;
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            // æ–‡å­—é™°å½±è®“å®ƒåœ¨äº®è‰²æ°£çƒä¸Šä¹Ÿæ˜é¡¯
            ctx.shadowColor = "rgba(0,0,0,0.5)";
            ctx.shadowBlur = 4;
            ctx.fillText(this.number, this.x, this.y + 2);
            ctx.shadowBlur = 0; // é‡ç½®
        }
    }

    class Particle {
        constructor(x, y, color) {
            this.x = x;
            this.y = y;
            this.radius = Math.random() * 6 + 3;
            this.vx = (Math.random() - 0.5) * 18;
            this.vy = (Math.random() - 0.5) * 18;
            this.color = color;
            this.life = 1.0;
        }
        update() {
            this.x += this.vx;
            this.y += this.vy;
            this.life -= 0.06; // æ¶ˆå¤±å¿«ä¸€é»
        }
        draw(ctx) {
            ctx.globalAlpha = Math.max(0, this.life);
            ctx.fillStyle = this.color;
            ctx.beginPath();
            ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
            ctx.fill();
            ctx.globalAlpha = 1.0;
        }
    }

    class Game {
        constructor() {
            this.state = 'menu';
            this.score = 0;
            this.mistakes = 0;
            this.startTime = 0;
            this.endTime = 0;
            
            this.balloons = [];
            this.particles = [];
            this.currentProblem = null;
            
            // DOM
            this.uiTime = document.getElementById('time-display');
            this.uiScore = document.getElementById('score-display');
            this.uiMistake = document.getElementById('mistake-display');
            this.uiQuestion = document.getElementById('question-display');
            this.barFill = document.getElementById('progress-bar-fill');
            this.timerLine = document.getElementById('timer-line');
            
            this.startScreen = document.getElementById('start-screen');
            this.endScreen = document.getElementById('end-screen');

            // Input
            const inputHandler = (e) => this.handleInput(e);
            canvas.addEventListener('mousedown', inputHandler);
            canvas.addEventListener('touchstart', inputHandler, {passive: false});
        }

        start() {
            this.state = 'playing';
            this.score = 0;
            this.mistakes = 0;
            this.balloons = [];
            this.particles = [];
            this.startTime = Date.now();
            
            this.startScreen.classList.add('hidden');
            this.endScreen.classList.add('hidden');
            this.uiQuestion.style.display = 'block';
            
            this.nextQuestion();
            requestAnimationFrame(() => this.loop());
        }

        nextQuestion() {
            // æª¢æŸ¥æ˜¯å¦é”æˆç›®æ¨™
            if (this.score >= TARGET_SCORE) {
                this.finishGame(true);
                return;
            }

            const a = Math.floor(Math.random() * 9) + 1;
            const b = Math.floor(Math.random() * 9) + 1;
            this.currentProblem = { a, b, val: a * b };
            
            this.uiQuestion.textContent = `${a} x ${b} = ?`;
            
            // è³½é“åˆ†é…
            let lanes = Array.from({length: LANES_COUNT}, (_, i) => i);
            lanes.sort(() => Math.random() - 0.5);
            
            this.balloons = [];

            // æ­£è§£
            this.balloons.push(new Balloon(this.currentProblem.val, true, lanes[0]));

            // éŒ¯èª¤é¸é …
            for(let i=1; i<LANES_COUNT; i++) {
                let fake;
                let safety = 0;
                do {
                    // æ··æ·†é‚è¼¯ï¼šå„ªå…ˆç”¢ç”Ÿçµå°¾æ•¸å­—ç›¸åŒçš„éŒ¯èª¤ç­”æ¡ˆ (ä¾‹å¦‚ 24 vs 14)
                    if (Math.random() > 0.5) {
                        let offset = (Math.floor(Math.random() * 2) === 0 ? 10 : -10);
                        fake = this.currentProblem.val + offset;
                    } else {
                        let offset = Math.floor(Math.random() * 10) - 5; 
                        if (offset === 0) offset = 1;
                        fake = this.currentProblem.val + offset;
                    }

                    // é‚Šç•Œæª¢æŸ¥
                    if (fake <= 0) fake = Math.floor(Math.random()*80) + 1;
                    
                    safety++;
                } while(
                    (fake === this.currentProblem.val || this.balloons.some(b => b.number === fake)) && safety < 50
                );
                
                this.balloons.push(new Balloon(fake, false, lanes[i]));
            }
        }

        handleInput(e) {
            if (this.state !== 'playing') return;
            e.preventDefault();

            let clientX, clientY;
            if(e.touches) {
                clientX = e.touches[0].clientX;
                clientY = e.touches[0].clientY;
            } else {
                clientX = e.clientX;
                clientY = e.clientY;
            }

            const rect = canvas.getBoundingClientRect();
            const x = clientX - rect.left;
            const y = clientY - rect.top;

            for (let b of this.balloons) {
                if (b.popped) continue;
                // å¯¬é¬†åˆ¤å®šç¯„åœ
                const dist = Math.sqrt((x - b.x)**2 + (y - b.y)**2);
                if (dist < b.radius * 1.3) {
                    this.popBalloon(b);
                    break; 
                }
            }
        }

        popBalloon(b) {
            b.popped = true;
            this.spawnExplosion(b.x, b.y, b.color);

            if (b.isCorrect) {
                this.score++;
                // è¦–è¦ºå›é¥‹ï¼šé–ƒå…‰
                const flash = document.createElement('div');
                flash.style.position = 'absolute';
                flash.style.top = 0; flash.style.left = 0;
                flash.style.width = '100%'; flash.style.height = '100%';
                flash.style.background = 'rgba(255,255,255,0.3)';
                flash.style.pointerEvents = 'none';
                flash.className = 'flash';
                document.body.appendChild(flash);
                setTimeout(() => flash.remove(), 200);

                // **æ¥µé€Ÿæ¨¡å¼ï¼šæ²’æœ‰å»¶é²ï¼Œç›´æ¥ä¸‹ä¸€é¡Œ**
                this.nextQuestion();
            } else {
                this.handleMistake();
            }
        }

        handleMistake() {
            this.mistakes++;
            // éŒ¯èª¤æ‡²ç½°ï¼šéœ‡å‹• + ç•«é¢è®Šç´… + ç¨å¾®å»¶é² (æ¨¡æ“¬æ€è€ƒå¡é “)
            document.body.classList.add('shake');
            document.body.style.backgroundColor = "#500"; 
            
            // éŒ¯èª¤æ™‚ä¸è¦é¦¬ä¸Šæ›é¡Œï¼Œè®“ç©å®¶çŸ¥é“é€™é¡Œç­”éŒ¯äº†ï¼Œå¿…é ˆé‡æ–°çœ‹
            // ä½†åœ¨æ¯”è³½æ¨¡æ“¬ä¸­ï¼Œé€šå¸¸ç­”éŒ¯å°±éå»äº†ï¼Œé€™è£¡æˆ‘å€‘é¸æ“‡ã€Œæ‡²ç½°æ™‚é–“ã€
            // æ°£çƒç¹¼çºŒé£›ï¼Œç©å®¶å¾—æ‰¾å‰©ä¸‹çš„æ°£çƒæˆ–æ˜¯ç­‰ä¸‹ä¸€æ³¢
            
            setTimeout(() => {
                document.body.classList.remove('shake');
                document.body.style.background = ""; // å¾©åŸèƒŒæ™¯
                // ç­”éŒ¯å¾Œå¼·åˆ¶åˆ·æ–°é¡Œç›® (é¿å…ç©å®¶ä¸€ç›´é»åŒä¸€å€‹éŒ¯çš„)
                this.nextQuestion(); 
            }, 400);
        }

        spawnExplosion(x, y, color) {
            for(let i=0; i<15; i++) {
                this.particles.push(new Particle(x, y, color));
            }
        }

        finishGame(isSuccess) {
            this.state = 'end';
            this.uiQuestion.style.display = 'none';
            this.endScreen.classList.remove('hidden');
            
            const elapsed = (Date.now() - this.startTime) / 1000;
            const finalTimeStr = elapsed.toFixed(1);

            document.getElementById('final-score').innerText = this.score;
            document.getElementById('final-time').innerText = finalTimeStr;
            document.getElementById('final-mistakes').innerText = this.mistakes;

            const title = document.getElementById('end-title');
            const reason = document.getElementById('end-reason');
            const feedback = document.getElementById('feedback-msg');

            if (isSuccess) {
                title.innerText = "ğŸ† æŒ‘æˆ°æˆåŠŸï¼ ğŸ†";
                title.style.color = "#00ff00";
                reason.innerText = `ä½ åœ¨ ${finalTimeStr} ç§’å…§å®Œæˆäº† 50 é¡Œï¼`;
                reason.style.color = "white";
                
                if (elapsed <= 100) {
                    feedback.innerText = "è©•èªï¼šç¥ç´šé€Ÿåº¦ï¼é€™æ ¹æœ¬æ˜¯åå°„ç¥ç¶“ï¼";
                } else if (elapsed <= 120) {
                    feedback.innerText = "è©•èªï¼šéå¸¸å„ªç§€ï¼æ¯”è³½æ™‚ä¿æŒé€™å€‹ç¯€å¥å°±ç©©äº†ã€‚";
                } else {
                    feedback.innerText = "è©•èªï¼šå£“ç·šéé—œï¼è¦å†åŠ å¿«ä¸€é»é»æ¯”è¼ƒä¿éšªå–”ã€‚";
                }
            } else {
                title.innerText = "æŒ‘æˆ°å¤±æ•—";
                title.style.color = "#ff4757";
                reason.innerText = "æ™‚é–“è€—ç›¡ï¼Œæœªé” 50 é¡Œã€‚";
                reason.style.color = "#ccc";
                feedback.innerText = "è©•èªï¼šä¸è¦ç°å¿ƒï¼ŒåŠ å¿«åˆ¤æ–·é€Ÿåº¦ï¼Œæ¸›å°‘çŒ¶è±«æ™‚é–“ï¼";
            }
        }

        loop() {
            if (this.state !== 'playing') return;

            const now = Date.now();
            const elapsed = (now - this.startTime) / 1000;
            const remaining = Math.max(0, TIME_LIMIT - elapsed);

            // æ›´æ–° UI
            this.uiTime.innerText = remaining.toFixed(1);
            this.uiScore.innerText = this.score;
            this.uiMistake.innerText = this.mistakes;
            
            // é€²åº¦æ¢æ›´æ–°
            const pct = (this.score / TARGET_SCORE) * 100;
            this.barFill.style.width = `${pct}%`;

            // ä¸‹æ–¹æ™‚é–“æ¢
            this.timerLine.style.width = `${(remaining / TIME_LIMIT) * 100}%`;
            if (remaining < 30) this.timerLine.style.background = "red";

            // æ™‚é–“åˆ°åˆ¤å®š
            if (remaining <= 0) {
                this.finishGame(false);
                return;
            }

            // ç¹ªåœ–èˆ‡é‚è¼¯
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // æ°£çƒ
            this.balloons.forEach(b => {
                b.update();
                // å¾ªç’°é‡ç”Ÿ (è®“ç•«é¢ä¸Šéš¨æ™‚æœ‰æ±è¥¿)
                if (b.y + b.radius < -50) {
                    b.y = canvas.height + b.radius + Math.random() * 100;
                    b.x = b.x; // ä¿æŒè³½é“
                    // å¦‚æœæ°£çƒé£›å‡ºå»äº†é‚„æ²’é»ï¼Œè¦–ç‚ºéŒ¯éï¼Œå¯ä»¥é¸æ“‡æ‡²ç½°æˆ–å–®ç´”é‡ç½®
                    // é€™è£¡ç‚ºäº†æµæš¢åº¦ï¼Œé‡ç½®ä½ç½®å°±å¥½ï¼Œä¸æ‰£åˆ†ï¼Œå› ç‚ºç©å®¶å·²ç¶“æµªè²»æ™‚é–“äº†
                }
                b.draw(ctx);
            });

            // ç²’å­
            for (let i = this.particles.length - 1; i >= 0; i--) {
                this.particles[i].update();
                this.particles[i].draw(ctx);
                if (this.particles[i].life <= 0) this.particles.splice(i, 1);
            }

            requestAnimationFrame(() => this.loop());
        }
    }

    const game = new Game();
</script>
</body>
</html>
