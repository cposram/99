<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¹ä¹ä¹˜æ³•ï¼šæ°£çƒç¥å°„æ‰‹ V2</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(to bottom, #87CEEB, #E0F7FA);
            user-select: none;
            cursor: crosshair;
            touch-action: none; /* é˜²æ­¢æ‰‹æ©Ÿè§¸æ§ç¸®æ”¾ */
        }
        
        #game-ui {
            position: absolute;
            top: 20px;
            left: 20px;
            color: #333;
            font-size: 24px;
            font-weight: bold;
            text-shadow: 2px 2px 0px rgba(255,255,255,0.5);
            pointer-events: none;
            z-index: 10;
        }

        #question-display {
            position: absolute;
            top: 12%;
            left: 50%;
            transform: translateX(-50%);
            font-size: clamp(40px, 8vw, 70px); /* éŸ¿æ‡‰å¼å­—é«” */
            font-weight: 900;
            color: #2c3e50;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px 40px;
            border-radius: 50px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            display: none;
            pointer-events: none;
            z-index: 10;
            white-space: nowrap;
        }

        #timer-bar-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 12px;
            background: #ddd;
            z-index: 10;
        }

        #timer-bar {
            height: 100%;
            background: #FF6B6B;
            width: 100%;
            transition: width 0.1s linear;
        }

        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            z-index: 100;
            padding: 20px;
            box-sizing: border-box;
            text-align: center;
        }

        .hidden {
            display: none !important;
        }

        h1 {
            font-size: clamp(30px, 6vw, 50px);
            margin-bottom: 20px;
            color: #FFD93D;
        }

        button {
            padding: 15px 40px;
            font-size: 24px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: transform 0.1s;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            font-weight: bold;
            margin-top: 20px;
        }

        button:active {
            transform: scale(0.95);
        }

        #report-card {
            background: white;
            color: #333;
            padding: 20px;
            border-radius: 20px;
            max-width: 600px;
            width: 90%;
            text-align: center;
            margin-bottom: 20px;
        }

        .stat-row {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
            font-size: 20px;
            font-weight: bold;
        }

        .error-list {
            text-align: left;
            background: #f9f9f9;
            padding: 15px;
            border-radius: 10px;
            max-height: 25vh;
            overflow-y: auto;
        }
        
        .error-item {
            color: #e74c3c;
            font-weight: bold;
            border-bottom: 1px solid #eee;
            padding: 8px 0;
            font-size: 18px;
        }

        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            10% { transform: translate(-1px, -2px) rotate(-1deg); }
            20% { transform: translate(-3px, 0px) rotate(1deg); }
            30% { transform: translate(3px, 2px) rotate(0deg); }
            40% { transform: translate(1px, -1px) rotate(1deg); }
            50% { transform: translate(-1px, 2px) rotate(-1deg); }
            60% { transform: translate(-3px, 1px) rotate(0deg); }
            70% { transform: translate(3px, 1px) rotate(-1deg); }
            80% { transform: translate(-1px, -1px) rotate(1deg); }
            90% { transform: translate(1px, 2px) rotate(0deg); }
            100% { transform: translate(1px, -2px) rotate(-1deg); }
        }
        
        .shake {
            animation: shake 0.5s;
            animation-iteration-count: 1;
        }
    </style>
</head>
<body>

    <div id="timer-bar-container"><div id="timer-bar"></div></div>
    <canvas id="gameCanvas"></canvas>

    <div id="game-ui">
        æ™‚é–“: <span id="time-display">120</span>s <br>
        å¾—åˆ†: <span id="score-display">0</span>
    </div>

    <div id="question-display">? x ? = ?</div>

    <div id="start-screen" class="overlay">
        <h1>ğŸˆ ä¹ä¹ä¹˜æ³•ç¥å°„æ‰‹ ğŸˆ</h1>
        <p style="font-size: 18px; margin-bottom: 30px; opacity: 0.9; line-height: 1.6;">
            æ–°ç‰ˆè¦å‰‡ï¼šæ°£çƒä¸å†é‡ç–Šï¼<br>
            ç¸½æ™‚é–“ 120 ç§’ï¼Œæ¯é¡Œ 7 ç§’ã€‚<br>
            çœ‹æº–åŒ…å«æ­£ç¢ºç­”æ¡ˆçš„æ°£çƒå°„æ“Šï¼
        </p>
        <button onclick="game.start()">é–‹å§‹éŠæˆ²</button>
    </div>

    <div id="end-screen" class="overlay hidden">
        <h1>éŠæˆ²çµæŸ</h1>
        <div id="report-card">
            <div class="stat-row">
                <div style="color: green;">âœ… ç­”å°: <span id="final-score">0</span></div>
                <div style="color: red;">âŒ ç­”éŒ¯: <span id="final-mistakes">0</span></div>
            </div>
            <div style="margin-top: 10px; font-weight: bold; text-align: left;">âš ï¸ éœ€åŠ å¼·çš„çµ„åˆï¼š</div>
            <div id="error-list-container" class="error-list">
                </div>
        </div>
        <button onclick="game.start()">å†ç©ä¸€æ¬¡</button>
    </div>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    
    // RWD Canvas
    function resize() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
    }
    window.addEventListener('resize', resize);
    resize();

    // éŠæˆ²åƒæ•¸
    const GAME_DURATION = 120; 
    const QUESTION_TIME = 7; 

    class Balloon {
        constructor(number, isCorrect, xPos, maxRadius) {
            this.radius = maxRadius; // å›ºå®šæœ€å¤§åŠå¾‘ï¼Œé¿å…é‡ç–Š
            this.x = xPos;
            this.y = canvas.height + this.radius + Math.random() * 150; // éŒ¯é–‹å‡ºç¾æ™‚é–“
            this.speed = canvas.height / (QUESTION_TIME * 60) * (1 + Math.random() * 0.5); // æ ¹æ“šé«˜åº¦å‹•æ…‹èª¿æ•´é€Ÿåº¦
            if(this.speed < 1.5) this.speed = 1.5; // æœ€ä½é€Ÿåº¦

            this.number = number;
            this.isCorrect = isCorrect;
            this.color = `hsl(${Math.random() * 360}, 75%, 65%)`;
            this.popped = false;
            
            // å¾®å¾®çš„å·¦å³æ“ºå‹•åƒæ•¸
            this.wobbleSpeed = Math.random() * 0.05 + 0.02;
            this.wobbleDistance = Math.random() * 20;
            this.originalX = xPos;
            this.timeOffset = Math.random() * 100;
        }

        update() {
            this.y -= this.speed;
            // è¼•å¾®å·¦å³æ“ºå‹•ï¼Œå¢åŠ å‹•æ„Ÿä½†ä¸å½±éŸ¿é»æ“Š
            this.x = this.originalX + Math.sin(this.y * 0.01 + this.timeOffset) * 10;
        }

        draw(ctx) {
            if (this.popped) return;
            
            // ç•«æ°£çƒæœ¬é«”
            ctx.beginPath();
            ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
            ctx.fillStyle = this.color;
            ctx.fill();
            
            // å…‰æ¾¤
            ctx.beginPath();
            ctx.arc(this.x - this.radius * 0.3, this.y - this.radius * 0.3, this.radius * 0.2, 0, Math.PI * 2);
            ctx.fillStyle = "rgba(255,255,255,0.3)";
            ctx.fill();

            // ç¹©å­
            ctx.beginPath();
            ctx.moveTo(this.x, this.y + this.radius);
            ctx.lineTo(this.x, this.y + this.radius + 40);
            ctx.strokeStyle = "#666";
            ctx.lineWidth = 2;
            ctx.stroke();

            // æ•¸å­—
            ctx.fillStyle = "white";
            // å­—é«”å¤§å°éš¨æ°£çƒå¤§å°èª¿æ•´
            ctx.font = `bold ${this.radius * 0.9}px Arial`; 
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            ctx.fillText(this.number, this.x, this.y);
            
            // é‚Šæ¡† (è®“æ°£çƒæ›´æ¸…æ¥š)
            ctx.beginPath();
            ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
            ctx.strokeStyle = "rgba(0,0,0,0.1)";
            ctx.lineWidth = 1;
            ctx.stroke();
        }
    }

    class Particle {
        constructor(x, y, color) {
            this.x = x;
            this.y = y;
            this.radius = Math.random() * 6 + 2;
            this.speedX = (Math.random() - 0.5) * 15;
            this.speedY = (Math.random() - 0.5) * 15;
            this.color = color;
            this.life = 1.0; 
            this.gravity = 0.5;
        }
        update() {
            this.x += this.speedX;
            this.y += this.speedY;
            this.speedY += this.gravity; // åŠ å…¥é‡åŠ›
            this.life -= 0.04;
        }
        draw(ctx) {
            ctx.globalAlpha = Math.max(0, this.life);
            ctx.fillStyle = this.color;
            ctx.beginPath();
            ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
            ctx.fill();
            ctx.globalAlpha = 1.0;
        }
    }

    class Game {
        constructor() {
            this.state = 'menu'; 
            this.score = 0;
            this.mistakes = 0;
            this.totalTime = GAME_DURATION;
            this.questionTime = QUESTION_TIME;
            
            this.currentProblem = null; 
            this.balloons = [];
            this.particles = [];
            this.errorLog = {}; 
            
            this.lastTime = 0;
            this.questionTimer = 0;
            
            this.uiTime = document.getElementById('time-display');
            this.uiScore = document.getElementById('score-display');
            this.uiQuestion = document.getElementById('question-display');
            this.timerBar = document.getElementById('timer-bar');
            this.startScreen = document.getElementById('start-screen');
            this.endScreen = document.getElementById('end-screen');

            // æ”¯æ´æ»‘é¼ èˆ‡è§¸æ§
            canvas.addEventListener('mousedown', (e) => this.handleClick(e.clientX, e.clientY));
            canvas.addEventListener('touchstart', (e) => {
                e.preventDefault(); // é˜²æ­¢æ»¾å‹•
                this.handleClick(e.touches[0].clientX, e.touches[0].clientY);
            }, {passive: false});
        }

        start() {
            this.state = 'playing';
            this.score = 0;
            this.mistakes = 0;
            this.totalTime = GAME_DURATION;
            this.errorLog = {};
            this.balloons = [];
            this.particles = [];
            
            this.startScreen.classList.add('hidden');
            this.endScreen.classList.add('hidden');
            this.uiQuestion.style.display = 'block';
            
            this.nextQuestion();
            requestAnimationFrame((t) => this.loop(t));
        }

        nextQuestion() {
            this.questionTimer = QUESTION_TIME;
            const a = Math.floor(Math.random() * 9) + 1;
            const b = Math.floor(Math.random() * 9) + 1;
            this.currentProblem = { a, b, val: a * b, str: `${a} x ${b}` };
            
            this.uiQuestion.textContent = `${a} x ${b} = ?`;
            
            this.balloons = [];
            
            // --- åˆ†é“æ©Ÿåˆ¶ (Lane System) ---
            const totalLanes = 5; // ç¸½å…±5é¡†æ°£çƒ
            const margin = 20; // é‚Šè·
            const laneWidth = (canvas.width - margin * 2) / totalLanes;
            
            // æ±ºå®šæ°£çƒåŠå¾‘ (ä¿è­‰ä¸é‡ç–Šï¼Œæœ€å¤§åŠå¾‘é™åˆ¶ 55)
            const balloonRadius = Math.min(laneWidth / 2 - 5, 55); 

            // å»ºç«‹è·‘é“ç´¢å¼•ä¸¦æ‰“äº‚ [0, 1, 2, 3, 4] -> [2, 0, 4, 1, 3]
            let lanes = Array.from({length: totalLanes}, (_, i) => i);
            lanes.sort(() => Math.random() - 0.5);

            // ç”Ÿæˆæ•¸å­—
            let numbers = [];
            // æ­£ç¢ºç­”æ¡ˆ
            numbers.push({ val: this.currentProblem.val, isCorrect: true });
            
            // éŒ¯èª¤ç­”æ¡ˆ
            for(let i=0; i < totalLanes - 1; i++) {
                let fake;
                let attempts = 0;
                do {
                    let offset = Math.floor(Math.random() * 18) - 9; 
                    if (offset === 0) offset = 5; // é¿å…+0
                    fake = Math.abs(this.currentProblem.val + offset);
                    
                    // ç‰¹æ®Šé™·é˜±ï¼šå¦‚æœæ˜¯å€‹ä½æ•¸ä¹˜æ³•ï¼Œå¯èƒ½æœƒå‡ºç¾å€‹ä½æ•¸éŒ¯èª¤ (ä¾‹å¦‚ 24 å‡º 21)
                    if (Math.random() > 0.5) {
                         fake = (Math.floor(Math.random() * 9) + 1) * (Math.floor(Math.random() * 9) + 1);
                    }
                    attempts++;
                } while ((fake === this.currentProblem.val || numbers.some(n => n.val === fake)) && attempts < 10);
                
                // å¦‚æœå˜—è©¦å¤ªä¹…éƒ½é‡è¤‡ï¼Œå°±å¼·åˆ¶+1
                if (fake === this.currentProblem.val) fake += 1;
                
                numbers.push({ val: fake, isCorrect: false });
            }

            // å‰µå»ºæ°£çƒç‰©ä»¶ï¼Œåˆ†é…åˆ°æ‰“äº‚çš„è·‘é“ä¸Š
            for (let i = 0; i < totalLanes; i++) {
                // è¨ˆç®—è©²è·‘é“çš„ä¸­å¿ƒ X åº§æ¨™
                let laneIndex = lanes[i];
                let centerX = margin + laneIndex * laneWidth + laneWidth / 2;
                
                this.balloons.push(new Balloon(numbers[i].val, numbers[i].isCorrect, centerX, balloonRadius));
            }
        }

        handleClick(clientX, clientY) {
            if (this.state !== 'playing') return;

            // ä¿®æ­£åº§æ¨™ (å¦‚æœ Canvas æœ‰åç§»)
            const rect = canvas.getBoundingClientRect();
            const clickX = clientX - rect.left;
            const clickY = clientY - rect.top;

            // æª¢æŸ¥é»æ“Š (ç”±ä¸Šå±¤å¾€ä¸‹å±¤æª¢æŸ¥)
            // é›–ç„¶ç¾åœ¨ä¸é‡ç–Šäº†ï¼Œä½†ä¿æŒé€™å€‹é‚è¼¯æ¯”è¼ƒå¥½
            for (let i = this.balloons.length - 1; i >= 0; i--) {
                const b = this.balloons[i];
                if (b.popped) continue;

                const dist = Math.sqrt((clickX - b.x) ** 2 + (clickY - b.y) ** 2);
                
                // å¢åŠ ä¸€é»é»åˆ¤å®šç¯„åœ (Radius * 1.2) è®“æ‰‹æ©Ÿæ¯”è¼ƒå¥½é»
                if (dist < b.radius * 1.2) {
                    this.popBalloon(b);
                    return; // ä¸€æ¬¡åªé»ä¸€é¡†
                }
            }
        }

        popBalloon(b) {
            b.popped = true;
            this.createExplosion(b.x, b.y, b.color);

            if (b.isCorrect) {
                this.score++;
                // ç­”å°æ’­æ”¾ä¸€å€‹æ¸…è„†éŸ³æ•ˆé‚è¼¯ï¼ˆé€™è£¡åƒ…è¦–è¦ºï¼‰
                setTimeout(() => this.nextQuestion(), 200);
            } else {
                this.handleError();
            }
        }

        handleError() {
            this.mistakes++;
            const key = this.currentProblem.str;
            this.errorLog[key] = (this.errorLog[key] || 0) + 1;

            // ç‚¸ç•«é¢
            document.body.classList.add('shake');
            document.body.style.backgroundColor = "#ff9999"; 
            
            setTimeout(() => {
                document.body.classList.remove('shake');
                document.body.style.backgroundColor = ""; 
            }, 400);

            // éŒ¯èª¤ä¹Ÿæ›é¡Œï¼Œé¿å…å¡æ­»
            setTimeout(() => this.nextQuestion(), 500);
        }

        createExplosion(x, y, color) {
            for (let i = 0; i < 25; i++) {
                this.particles.push(new Particle(x, y, color));
            }
        }

        loop(timestamp) {
            if (this.state !== 'playing') return;

            const dt = (timestamp - this.lastTime) / 1000;
            this.lastTime = timestamp;

            if (dt < 1) { 
                this.totalTime -= dt;
                this.questionTimer -= dt;
            }

            // å–®é¡Œè¶…æ™‚
            if (this.questionTimer <= 0) {
                // åœ¨é¡Œç›®ä¸­é–“ç”¢ç”Ÿä¸€å€‹çˆ†ç‚¸æç¤º
                const rect = this.uiQuestion.getBoundingClientRect();
                this.createExplosion(rect.left + rect.width/2, rect.top + rect.height/2, "red");
                this.handleError(); 
            }

            // éŠæˆ²çµæŸ
            if (this.totalTime <= 0) {
                this.endGame();
                return;
            }

            // UI æ›´æ–°
            this.uiTime.textContent = Math.ceil(this.totalTime);
            this.uiScore.textContent = this.score;
            this.timerBar.style.width = `${Math.max(0, (this.questionTimer / QUESTION_TIME) * 100)}%`;
            this.timerBar.style.backgroundColor = this.questionTimer < 2 ? "red" : "#FF6B6B";

            // ç¹ªåœ–
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // æ°£çƒé‚è¼¯
            let activeBalloons = false;
            this.balloons.forEach(b => {
                if (!b.popped) {
                     b.update();
                     // å¦‚æœæ°£çƒé£„å‡ºå»äº†ï¼Œè®“å®ƒå¾ä¸‹é¢å›ä¾† (ç„¡é™å¾ªç’°ç›´åˆ°è©²é¡ŒçµæŸ)
                     if (b.y + b.radius < -50) {
                         b.y = canvas.height + b.radius;
                     }
                     b.draw(ctx);
                     activeBalloons = true;
                }
            });

            // ç²’å­é‚è¼¯
            for (let i = this.particles.length - 1; i >= 0; i--) {
                const p = this.particles[i];
                p.update();
                p.draw(ctx);
                if (p.life <= 0) this.particles.splice(i, 1);
            }

            requestAnimationFrame((t) => this.loop(t));
        }

        endGame() {
            this.state = 'end';
            this.uiQuestion.style.display = 'none';
            this.endScreen.classList.remove('hidden');
            
            document.getElementById('final-score').textContent = this.score;
            document.getElementById('final-mistakes').textContent = this.mistakes;

            const listContainer = document.getElementById('error-list-container');
            listContainer.innerHTML = '';
            
            const sortedErrors = Object.entries(this.errorLog).sort((a, b) => b[1] - a[1]);

            if (sortedErrors.length === 0 && this.mistakes === 0) {
                listContainer.innerHTML = '<div style="color:green;">ğŸ’¯ å®Œç¾ï¼å®Œå…¨æ²’æœ‰éŒ¯èª¤ï¼</div>';
            } else if (sortedErrors.length === 0) {
                 listContainer.innerHTML = '<div>æ²’æœ‰ç‰¹å®šçµ„åˆéŒ¯èª¤ (çš†ç‚ºè¶…æ™‚)ã€‚</div>';
            } else {
                sortedErrors.slice(0, 5).forEach(item => { 
                    const div = document.createElement('div');
                    div.className = 'error-item';
                    div.innerHTML = `${item[0]} <span style="float:right; color:#888;">éŒ¯èª¤ ${item[1]} æ¬¡</span>`;
                    listContainer.appendChild(div);
                });
            }
        }
    }

    const game = new Game();

</script>
</body>
</html>
