<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¹ä¹ä¹˜æ³•ï¼šæ°£çƒç¥å°„æ‰‹</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(to bottom, #87CEEB, #E0F7FA);
            user-select: none;
            cursor: crosshair; /* å°„æ“Šæº–å¿ƒ */
        }
        
        #game-ui {
            position: absolute;
            top: 20px;
            left: 20px;
            color: #333;
            font-size: 24px;
            font-weight: bold;
            text-shadow: 2px 2px 0px rgba(255,255,255,0.5);
            pointer-events: none;
        }

        #question-display {
            position: absolute;
            top: 10%;
            left: 50%;
            transform: translateX(-50%);
            font-size: 60px;
            font-weight: 900;
            color: #2c3e50;
            background: rgba(255, 255, 255, 0.8);
            padding: 10px 40px;
            border-radius: 50px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            display: none;
            pointer-events: none;
        }

        #timer-bar-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 10px;
            background: #ddd;
        }

        #timer-bar {
            height: 100%;
            background: #FF6B6B;
            width: 100%;
            transition: width 0.1s linear;
        }

        /* éŠæˆ²çµæŸ & é–‹å§‹ç•«é¢ */
        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            z-index: 100;
        }

        .hidden {
            display: none !important;
        }

        h1 {
            font-size: 50px;
            margin-bottom: 20px;
            color: #FFD93D;
        }

        button {
            padding: 15px 40px;
            font-size: 24px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: transform 0.2s, background 0.2s;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            font-weight: bold;
        }

        button:hover {
            transform: scale(1.05);
            background-color: #45a049;
        }

        #report-card {
            background: white;
            color: #333;
            padding: 30px;
            border-radius: 20px;
            max-width: 600px;
            width: 80%;
            text-align: center;
            margin-bottom: 20px;
        }

        .stat-row {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
            font-size: 20px;
        }

        .error-list {
            text-align: left;
            background: #f9f9f9;
            padding: 15px;
            border-radius: 10px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .error-item {
            color: #e74c3c;
            font-weight: bold;
            border-bottom: 1px solid #eee;
            padding: 5px 0;
        }
        
        /* ç­”éŒ¯æ™‚çš„éœ‡å‹•æ•ˆæœ */
        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            10% { transform: translate(-1px, -2px) rotate(-1deg); }
            20% { transform: translate(-3px, 0px) rotate(1deg); }
            30% { transform: translate(3px, 2px) rotate(0deg); }
            40% { transform: translate(1px, -1px) rotate(1deg); }
            50% { transform: translate(-1px, 2px) rotate(-1deg); }
            60% { transform: translate(-3px, 1px) rotate(0deg); }
            70% { transform: translate(3px, 1px) rotate(-1deg); }
            80% { transform: translate(-1px, -1px) rotate(1deg); }
            90% { transform: translate(1px, 2px) rotate(0deg); }
            100% { transform: translate(1px, -2px) rotate(-1deg); }
        }
        
        .shake {
            animation: shake 0.5s;
            animation-iteration-count: 1;
        }

    </style>
</head>
<body>

    <div id="timer-bar-container"><div id="timer-bar"></div></div>
    <canvas id="gameCanvas"></canvas>

    <div id="game-ui">
        æ™‚é–“: <span id="time-display">120</span>s <br>
        å¾—åˆ†: <span id="score-display">0</span>
    </div>

    <div id="question-display">? x ? = ?</div>

    <div id="start-screen" class="overlay">
        <h1>ğŸˆ ä¹ä¹ä¹˜æ³•æ°£çƒæˆ° ğŸˆ</h1>
        <p style="font-size: 20px; margin-bottom: 30px; opacity: 0.9;">
            è¦å‰‡ï¼šç¸½æ™‚é–“ 120 ç§’ã€‚<br>
            æ¯é¡Œåªæœ‰ 7 ç§’ï¼Œé»æ“Šå«æ­£ç¢ºç­”æ¡ˆçš„æ°£çƒã€‚<br>
            ç­”éŒ¯æœƒçˆ†ç‚¸ï¼åŠ æ²¹ï¼
        </p>
        <button onclick="game.start()">é–‹å§‹éŠæˆ²</button>
    </div>

    <div id="end-screen" class="overlay hidden">
        <h1>éŠæˆ²çµæŸ</h1>
        <div id="report-card">
            <div class="stat-row">
                <div style="color: green;">âœ… ç­”å°: <span id="final-score">0</span></div>
                <div style="color: red;">âŒ ç­”éŒ¯: <span id="final-mistakes">0</span></div>
            </div>
            <div style="margin-top: 10px; font-weight: bold;">âš ï¸ æœ€å¸¸éŒ¯èª¤æ’è¡Œæ¦œï¼š</div>
            <div id="error-list-container" class="error-list">
                </div>
        </div>
        <button onclick="game.start()">å†ç©ä¸€æ¬¡</button>
    </div>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    
    // RWD Canvas
    function resize() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
    }
    window.addEventListener('resize', resize);
    resize();

    // éŠæˆ²åƒæ•¸
    const GAME_DURATION = 120; // ç¸½æ™‚é–“
    const QUESTION_TIME = 7; // æ¯é¡Œæ™‚é–“

    class Balloon {
        constructor(number, isCorrect) {
            this.radius = 40 + Math.random() * 10;
            this.x = Math.random() * (canvas.width - this.radius * 2) + this.radius;
            this.y = canvas.height + this.radius + Math.random() * 100;
            this.speed = 1.5 + Math.random() * 2; // ä¸Šå‡é€Ÿåº¦
            this.number = number;
            this.isCorrect = isCorrect;
            this.color = `hsl(${Math.random() * 360}, 70%, 60%)`;
            this.popped = false;
        }

        update() {
            this.y -= this.speed;
        }

        draw(ctx) {
            if (this.popped) return;
            
            // ç•«æ°£çƒæœ¬é«”
            ctx.beginPath();
            ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
            ctx.fillStyle = this.color;
            ctx.fill();
            
            // å…‰æ¾¤
            ctx.beginPath();
            ctx.arc(this.x - this.radius * 0.3, this.y - this.radius * 0.3, this.radius * 0.2, 0, Math.PI * 2);
            ctx.fillStyle = "rgba(255,255,255,0.3)";
            ctx.fill();

            // ç¹©å­
            ctx.beginPath();
            ctx.moveTo(this.x, this.y + this.radius);
            ctx.lineTo(this.x, this.y + this.radius + 30);
            ctx.strokeStyle = "#555";
            ctx.stroke();

            // æ•¸å­—
            ctx.fillStyle = "white";
            ctx.font = `bold ${this.radius}px Arial`;
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            ctx.fillText(this.number, this.x, this.y);
        }
    }

    class Particle {
        constructor(x, y, color) {
            this.x = x;
            this.y = y;
            this.radius = Math.random() * 5 + 2;
            this.speedX = (Math.random() - 0.5) * 10;
            this.speedY = (Math.random() - 0.5) * 10;
            this.color = color;
            this.life = 1.0; // é€æ˜åº¦
        }
        update() {
            this.x += this.speedX;
            this.y += this.speedY;
            this.life -= 0.05;
        }
        draw(ctx) {
            ctx.globalAlpha = this.life;
            ctx.fillStyle = this.color;
            ctx.beginPath();
            ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
            ctx.fill();
            ctx.globalAlpha = 1.0;
        }
    }

    class Game {
        constructor() {
            this.state = 'menu'; // menu, playing, end
            this.score = 0;
            this.mistakes = 0;
            this.totalTime = GAME_DURATION;
            this.questionTime = QUESTION_TIME;
            
            this.currentProblem = null; // {a, b, ans}
            this.balloons = [];
            this.particles = [];
            this.errorLog = {}; // {"7x8": 2}
            
            this.lastTime = 0;
            this.questionTimer = 0;
            
            // DOM Elements
            this.uiTime = document.getElementById('time-display');
            this.uiScore = document.getElementById('score-display');
            this.uiQuestion = document.getElementById('question-display');
            this.timerBar = document.getElementById('timer-bar');
            this.startScreen = document.getElementById('start-screen');
            this.endScreen = document.getElementById('end-screen');

            // Bind click
            canvas.addEventListener('mousedown', (e) => this.handleClick(e));
        }

        start() {
            this.state = 'playing';
            this.score = 0;
            this.mistakes = 0;
            this.totalTime = GAME_DURATION;
            this.errorLog = {};
            this.balloons = [];
            this.particles = [];
            
            this.startScreen.classList.add('hidden');
            this.endScreen.classList.add('hidden');
            this.uiQuestion.style.display = 'block';
            
            this.nextQuestion();
            requestAnimationFrame((t) => this.loop(t));
        }

        nextQuestion() {
            this.questionTimer = QUESTION_TIME;
            const a = Math.floor(Math.random() * 9) + 1;
            const b = Math.floor(Math.random() * 9) + 1;
            this.currentProblem = { a, b, val: a * b, str: `${a} x ${b}` };
            
            this.uiQuestion.textContent = `${a} x ${b} = ?`;
            
            // ç”Ÿæˆæ°£çƒ
            this.balloons = [];
            
            // 1å€‹æ­£ç¢ºç­”æ¡ˆ
            this.balloons.push(new Balloon(this.currentProblem.val, true));
            
            // 3-4å€‹éŒ¯èª¤ç­”æ¡ˆ
            const count = 3 + Math.floor(Math.random()*2);
            for(let i=0; i<count; i++) {
                let fake;
                do {
                    // ç”¢ç”Ÿç›¸è¿‘çš„éŒ¯èª¤ç­”æ¡ˆ (ä¾‹å¦‚ +10, -10, æˆ–å€‹ä½æ•¸è®Šå‹•)
                    let offset = Math.floor(Math.random() * 20) - 10; 
                    if (offset === 0) offset = 1;
                    fake = Math.abs(this.currentProblem.val + offset);
                    // ç¢ºä¿ä¸ç‚ºè² æ•¸ä¸”ä¸ç­‰æ–¼æ­£ç¢ºç­”æ¡ˆ
                } while (fake === this.currentProblem.val || fake <= 0 || this.balloons.some(b => b.number === fake));
                
                this.balloons.push(new Balloon(fake, false));
            }
        }

        handleClick(e) {
            if (this.state !== 'playing') return;

            const rect = canvas.getBoundingClientRect();
            const clickX = e.clientX - rect.left;
            const clickY = e.clientY - rect.top;

            let hit = false;

            // å¾æœ€ä¸Šé¢çš„æ°£çƒé–‹å§‹æª¢æŸ¥ (å› ç‚ºå¾Œç•«çš„åœ¨ä¸Šé¢ï¼Œé™£åˆ—é †åºå¦‚æœåéä¾†æª¢æŸ¥æœƒæ›´æº–ï¼Œé€™è£¡ç°¡å–®åš)
            for (let i = this.balloons.length - 1; i >= 0; i--) {
                const b = this.balloons[i];
                if (b.popped) continue;

                const dist = Math.sqrt((clickX - b.x) ** 2 + (clickY - b.y) ** 2);
                if (dist < b.radius) {
                    hit = true;
                    this.popBalloon(b);
                    break; // ä¸€æ¬¡åªå°„ç ´ä¸€é¡†
                }
            }

            // å¦‚æœæ²’å°„ä¸­ï¼Œè¦–ç‚ºç©ºæ§ (å¯é¸ï¼šæ˜¯å¦æ‡²ç½°ï¼Ÿé€™è£¡æš«ä¸æ‡²ç½°ç©ºæ§ï¼Œåªæ‡²ç½°å°„éŒ¯æˆ–è¶…æ™‚)
        }

        popBalloon(b) {
            b.popped = true;
            this.createExplosion(b.x, b.y, b.color);

            if (b.isCorrect) {
                // ç­”å°
                this.score++;
                // ç¨å¾®å»¶é²ä¸€ä¸‹å†ä¸‹ä¸€é¡Œï¼Œè®“ç©å®¶çœ‹åˆ°çˆ†ç‚¸
                setTimeout(() => this.nextQuestion(), 200);
            } else {
                // ç­”éŒ¯
                this.handleError();
            }
        }

        handleError() {
            // ç­”éŒ¯é‚è¼¯
            this.mistakes++;
            // è¨˜éŒ„éŒ¯èª¤çµ„åˆ
            const key = this.currentProblem.str;
            this.errorLog[key] = (this.errorLog[key] || 0) + 1;

            // è¦–è¦ºåé¥‹ï¼šéœ‡å‹•èˆ‡ç´…å…‰
            document.body.classList.add('shake');
            document.body.style.backgroundColor = "#ffcccc"; // ç¬é–“è®Šç´…
            setTimeout(() => {
                document.body.classList.remove('shake');
                document.body.style.backgroundColor = ""; // æ¢å¾©èƒŒæ™¯
            }, 500);

            // é¡Œç›®ä¾ç„¶æ›ä¸‹ä¸€é¡Œ (é¡Œç›®èªªç­”éŒ¯äº†å°±ç‚¸æˆ‘ä¸¦åŠ å…¥æˆç¸¾ï¼Œç„¶å¾Œé€šå¸¸é€™ç¨®éŠæˆ²æœƒæ›é¡Œä»¥å…å¡ä½)
            setTimeout(() => this.nextQuestion(), 500);
        }

        createExplosion(x, y, color) {
            for (let i = 0; i < 20; i++) {
                this.particles.push(new Particle(x, y, color));
            }
        }

        loop(timestamp) {
            if (this.state !== 'playing') return;

            const dt = (timestamp - this.lastTime) / 1000;
            this.lastTime = timestamp;

            // æ›´æ–°æ™‚é–“
            if (dt < 1) { // é¿å…åˆ‡æ›åˆ†é é€ æˆæ™‚é–“è·³èº
                this.totalTime -= dt;
                this.questionTimer -= dt;
            }

            // æª¢æŸ¥å–®é¡Œè¶…æ™‚
            if (this.questionTimer <= 0) {
                // è¶…æ™‚è¦–åŒéŒ¯èª¤
                this.createExplosion(canvas.width/2, canvas.height/2, "red"); // è¢å¹•ä¸­å¤®çˆ†ç‚¸
                this.handleError(); 
            }

            // æª¢æŸ¥éŠæˆ²çµæŸ
            if (this.totalTime <= 0) {
                this.endGame();
                return;
            }

            // æ›´æ–° UI
            this.uiTime.textContent = Math.ceil(this.totalTime);
            this.uiScore.textContent = this.score;
            this.timerBar.style.width = `${(this.questionTimer / QUESTION_TIME) * 100}%`;
            if (this.questionTimer < 2) {
                this.timerBar.style.backgroundColor = "red";
            } else {
                this.timerBar.style.backgroundColor = "#FF6B6B";
            }

            // æ¸…é™¤ç•«å¸ƒ
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // æ›´æ–°èˆ‡ç¹ªè£½æ°£çƒ
            this.balloons.forEach(b => {
                b.update();
                // æ°£çƒé£„å‡ºé ‚éƒ¨é‡ç½®åˆ°åº•éƒ¨ (å¾ªç’°)
                if (b.y + b.radius < 0) {
                    b.y = canvas.height + b.radius;
                    b.x = Math.random() * (canvas.width - b.radius * 2) + b.radius;
                }
                b.draw(ctx);
            });

            // æ›´æ–°èˆ‡ç¹ªè£½ç²’å­
            for (let i = this.particles.length - 1; i >= 0; i--) {
                const p = this.particles[i];
                p.update();
                p.draw(ctx);
                if (p.life <= 0) this.particles.splice(i, 1);
            }

            requestAnimationFrame((t) => this.loop(t));
        }

        endGame() {
            this.state = 'end';
            this.uiQuestion.style.display = 'none';
            this.endScreen.classList.remove('hidden');
            
            document.getElementById('final-score').textContent = this.score;
            document.getElementById('final-mistakes').textContent = this.mistakes;

            // è™•ç†éŒ¯èª¤æ’è¡Œ
            const listContainer = document.getElementById('error-list-container');
            listContainer.innerHTML = '';
            
            // å°‡ç‰©ä»¶è½‰é™£åˆ—ä¸¦æ’åº
            const sortedErrors = Object.entries(this.errorLog).sort((a, b) => b[1] - a[1]);

            if (sortedErrors.length === 0 && this.mistakes === 0) {
                listContainer.innerHTML = '<div style="color:green; font-size:18px;">å¤ªå¼·äº†ï¼å…¨å°ï¼æ²’æœ‰éŒ¯èª¤ç´€éŒ„ã€‚ğŸ‰</div>';
            } else if (sortedErrors.length === 0) {
                 listContainer.innerHTML = '<div>æ²’æœ‰ç‰¹å®šçš„éŒ¯èª¤çµ„åˆç´€éŒ„ (å¯èƒ½æ˜¯å› ç‚ºè¶…æ™‚æœªç­”)ã€‚</div>';
            } else {
                sortedErrors.slice(0, 5).forEach(item => { // å–å‰äº”å
                    const div = document.createElement('div');
                    div.className = 'error-item';
                    div.textContent = `${item[0]} (éŒ¯ ${item[1]} æ¬¡)`;
                    listContainer.appendChild(div);
                });
            }
        }
    }

    const game = new Game();

</script>
</body>
</html>
